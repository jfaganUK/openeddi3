<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="./niBoxpop-name.html">

<dom-module id="oe-ni-boxpop">
    <style>
    </style>
    <template>
        <!--<div id="helpText" inner-h-t-m-l="{{oe.helpText}}"></div>-->
        <oe-ni-boxpop-undo last-save="{{lastSave}}" array-prompts="{{oe.arrayPrompts}}"></oe-ni-boxpop-undo>
        <template is="dom-repeat" items="{{oe.names}}">
            <oe-ni-boxpop-name name="{{item}}" array-prompts="{{oe.arrayPrompts}}"
                               on-boxpop="saveResponse"></oe-ni-boxpop-name>
        </template>
    </template>
    <script>
        Polymer({
            is: 'oe-ni-boxpop',
            properties: {
                oe: {type: 'Object', notify: true},
                namelist: {type: 'String', notify: true},
                response: {type: Object, notify: true},
                lastSave: {type: Object, notify: true}
            },
            listeners: {
                'undo': 'undoLast'
            },
            saveResponse: function (e) {
                e.stopPropagation();
                var prompt = _(this.oe.arrayPrompts)
                        .findWhere({value: e.target.responseValue})
                        .prompt;
                var o = {
                    id: e.model.get('item.id'),
                    name: e.model.get('item.name'),
                    value: e.target.responseValue,
                    prompt: prompt,
                    eid: this.oe.eid
                };
                this.set('lastSave', o);
                app.channels.namelist.command('save-name-detail', o);
            },
            undoLast: function () {
                var allnames = this.shadowRoot.querySelectorAll('oe-ni-boxpop-name');
                var lastid = this.lastSave.id;
                var lastnode = _(allnames).filter(function (x) {
                    return x.name.id == lastid;
                }).value()[0];
                lastnode.show();
                console.log('undoooo');
            }

        });
    </script>
</dom-module>