<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/neon-animation/neon-animated-pages.html"/>
<link rel="import" href="../../oe_client/components/oe-helptext.html"/>
<link rel="import" href="./niBoxpop-name.html">
<link rel="import" href="./niBoxPop-endoflist.html">

<dom-module id="oe-ni-boxpop">
    <style>
        #name-pager {
            height: 20em;
        }

        #endOfList {
            display: block;
            margin: 0.5em 1em;
            padding: 0.5em;
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: white;
        }
    </style>
    <template>
        <template is="dom-if" if="{{oe.helpText}}">
            <oe-helptext id="helpText" help-text="{{oe.helpText}}"></oe-helptext>
        </template>

        <oe-ni-boxpop-undo last-save="{{lastSave}}" array-prompts="{{oe.arrayPrompts}}"></oe-ni-boxpop-undo>
        <neon-animated-pages id="name-pager" class="flex" selected="[[nameIndex]]">
            <template is="dom-repeat" items="{{oe.names}}" filter="nameFilter">
                <oe-ni-boxpop-name name="{{item}}" array-prompts="{{oe.arrayPrompts}}"
                                   on-boxpop="saveResponse"></oe-ni-boxpop-name>
            </template>
            <oe-ni-boxpop-endoflist on-startover="reset"></oe-ni-boxpop-endoflist>
        </neon-animated-pages>
    </template>
    <script>
        Polymer({
            is: 'oe-ni-boxpop',
            properties: {
                oe: {type: Object, notify: true},
                namelist: {type: String, notify: true},
                response: {type: Object, notify: true},
                lastSave: {type: Object, notify: true},
                nameIndex: {type: Number, default: 0}
            },
            listeners: {
                'undo': 'undoLast'
            },
            ready: function () {
                this.reset();
            },
            reset: function () {
                this.$['name-pager'].selected = 0;
            },
            nameFilter: function (e) {
                if (this.oe.filter) {
                    if (this.oe.filter.details) {
                        var fil = this.oe.filter.details;
                        return e.details[fil.key] == fil.value;
                    }
                }
                return true;
            },
            saveResponse: function (e) {
                e.stopPropagation();
                var prompt = _(this.oe.arrayPrompts)
                        .findWhere({arrayid: e.target.responseValue})
                        .prompt;
                var o = {
                    id: e.model.get('item.id'),
                    name: e.model.get('item.name'),
                    value: e.target.responseValue,
                    prompt: prompt,
                    eid: this.oe.eid
                };
                this.set('lastSave', o);
                app.channels.namelist.command('save-name-detail', o);
                this.$['name-pager'].selectNext();
            },
            undoLast: function () {
                this.$['name-pager'].selectPrevious();
            }

        });
    </script>
</dom-module>